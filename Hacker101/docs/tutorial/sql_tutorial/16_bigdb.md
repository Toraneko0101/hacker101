# (クイズ16:大規模DB)

## Q137 パーティショニングについて知っていますか?

??? success
    ### 年々肥大化するDB

    ```text
    ・RDBの初期は、ハードディスクの容量もせいぜい数MB
    
    ・今はTB, PB, EB単位になりつつある

    ・クラウドのストレージに至っては、金を払えば
      実質無制限ともいえる
    ```

    ### DBが大きくなりすぎるとどうなるか

    ```text
    [以下のタスクが時間を要し、イライラしだす]

    ・フルテーブルスキャン
    ・Indexの作成と再構築
    ・データのアーカイブと削除
    ・Table/Indexの統計データの作成
    ・Tableの再配置
    ・DBのBackUp

    [時間を要するとどうなるか]
    ・管理の時間は有限なので、管理しなくなる
    ```

    ### パーティショニングとは

    ```text
    ・大きなテーブルを分割すること
    ・最初に分割(パーティショニング)しておくのが簡単

    ・管理タスクは個々のパーティションで行ったり、
      同時に行ったりする
    
    ・タスクによってはパーティションをスキップ可能
    ```

    ### パーティショニング概要

    ```text
    [概要]
    ・全てのDBサーバにはTable/Indexを分割する機能がある

    ・Tableを分割すると、2つ以上の
      テーブルパーティションが生成される
    
    ・それぞれのパーティションの定義は同じ

    ・分割しているので、重なっているデータ部分はない

    [分割の例]
    ・売上データを月ごとに分割する
    ・売上データを、地域ごとに分割する

    [分割した後のテーブル]
    ・仮想概念になる
    ・データを実際に含んでいるのはパーティション
    ・Indexもパーティション内のデータに基づき作成される

    ★ユーザ側はテーブルが分割されていることを意識しないまま
      使い続けることが可能
    ```

    ### 同じでなければならないものと違っていてもいいもの

    ```text
    [同じ]
    ・各パーティションのスキーマ定義（テーブルの列や型）は
      同じである必要がある
    
    [違う]
    ・各パーティションが、物理的に異なるストレージの
      別の表領域に格納されていてもいい
    
    ・各パーティションを、異なる圧縮方式で圧縮してもいい

    ・一部のパーティションで、パーティションごとの専用の
      Indexであるローカルインデックスを削除可能
    
    ・一部のパーティションで、テーブルの統計データを凍結
      することが可能
    
    ・よりアクセスするパーティションをメモリに保管し
      アクセスしないデータをフラッシュストレージに格納する
      ことで、効率的にメモリを使うことが可能
    ```

## Q138 テーブルやインデックスの分割手法について知っていますか?

??? success
    ### 水平分割

    ```text
    ・行全体を1つのパーティションに割り当てる

    ・パーティションキーを（多くの場合単一の）列に割り当て
      この列にパーティション関数を適用することで、
      各行を割り当てるパーティションを決定する
    ```

    ### 垂直分割

    ```text
    ・行内の列を異なるパーティションに配置する
    
    ・全ての列が必要でない場合、
      頻繁に使用する列に対して応答速度を上げたい場合に使用
    ```

    ### グローバル/ローカルインデックス

    ```text
    ・分割したテーブルにインデックスが含まれている場合
      ⇒インデックスをそのまま使う（グローバルインデックス）

      ⇒インデックスを分割して、パーティションごとに
        専用のIndexを割り当てる（ローカルインデックス）
    
    [ローカルインデックスの使いどころ]

    ・検索が各パーティション内で完結する場合
      ⇒他のパーティションは必要ないので
        ローカルインデックスがあるといい
      
    ・更にクエリでパーティションキーの値を指定する場合
      （一般的にパーティションキーが
      　ローカルインデックスになるので）

    [グローバルインデックスの使いどころ]

    ・複数パーティションを縦断する検索を行う場合
      ⇒グローバルインデックスは、すべてのパーティション
      　にまたがるインデックスなので全てのパーティション
      　を調べる手間が省ける
    
    ・検索は単一パーティション内で完結するが、
    　クエリでパーティションキーの値を使用しない場合
      ⇒パーティションキーによるインデックス付けが行えないので
        グローバルインデックスを使用する
    ```

    ### 例

    ```sql
    -- tableをsale_date列で分割し、
    -- geo_region_cd列がglobal indexとする

    -- 更に1つのパーティション内でクエリは実行されるとする

    /*
    パーティションキーが使われていないので、
    global indexが使える
    */
    select
      sum(amount)
    from
      sales
    where
      geo_region_cd = "US"
    ;

    /*
    パーティションキーが使われているので
    local indexが使える
    */
    select
      sum(amount)
    from
      sales
    where 
      sale_date 
      between "2007-01-01" and "2008-01-01"
    ;

    ```

## Q139 分割の種類を知っていますか?

??? success
    ### 範囲分割
